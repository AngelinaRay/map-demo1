---
title: "Демонстрация работы библиотеки leaflet для нанесения данных на карту"
author: "Ilya Kochergin"
date: "Saturday, April 02, 2016"
output: html_document
---

# Нанесение точек


Включаем библиотеки 

```{r libaries ,message=FALSE,results='hide'}
library(leaflet)
library(dplyr)
library(xtable)
library(htmltools)

```


## Грузим данные 

Загружаем  данные о нескольких знаниях МГУ в формате:

* название (name),
* адрес сайта (url)
* долгота (longitude)
* широта (latitude)


```{r}
geotagsMGU <- read.table(header=TRUE,
                         as.is=TRUE,
                         row.names=1,
                         sep=",",
                         text=
"name,url,latitude,longitude
Главное здание МГУ, http://www.msu.ru/info/map/gz.html, 55.703056, 37.530556
Экономический факультет МГУ, http://econ.msu.ru, 55.696040, 37.537793
Ботанический сад МГУ, http://botsad.msu.ru, 55.707701, 37.527202
Дом аспиранта и стажера МГУ (ДАС), http://www.msu.ru/depts/host/das.html, 55.691361, 37.595927
Филиал дома студента МГУ (ФДС), http://www.msu.ru/depts/host/fds.html, 55.707039, 37.509166
")
```

### Форматируем таблицу координат для выдачи в аккуратном виде

* функция `autoformat(xtab)` автоматически выравнивает текстовые столбцы по левому, а числовые -- по правому краю (по разрядам)
* параметр `zap=5` -- 5 цифр после "запятой" в числовых полях

```{r, results="asis", digits=5}
xtab <-  xtable(geotagsMGU ) %>% autoformat(zap=5)
caption(xtab) <- "Таблица 1. Координаты объектов МГУ"
print(xtab,type="html", caption.placement="top", html.table.attributes="border='3' width='100%'")

```

Для удобства добавим столбец name в фрейм данных geotagsMGU

```{r}
geotagsMGU$name <- rownames(geotagsMGU)
```


## Рисуем карты и наносим объекты с всплывающими описаниями

Создадим объект-карту 

```{r}
m <- leaflet() %>% 
     addTiles() 
```

Создадим фрейм данных, состоящий только из строчки про Экономический факультет.

```{r}
geotagsEF <-  geotagsMGU["Экономический факультет МГУ",]

geotagsEF
```

Установим масштаб (zoom) карты и укажем 1 точку в центре ее
Если нажать на точку, появится всплывающее окно (popup window)

```{r}
m %>% 
  setView(lng=geotagsEF$longitude, lat=geotagsEF$latitude, zoom = 15) %>%
  addMarkers(lng=geotagsEF$longitude, lat=geotagsEF$latitude, 
    popup="<b>ЭФ МГУ</b><br><a href='http://www.econ.msu.ru'>сайт факультета</a>")
```


Теперь указываем не масштаб, а границы. Хотим чтобы карта включала прямоугольник, диагональ которого проведена между 2-мя общежитиями ДАС и ФДС. Используем функцию fitBounds() для определения границ карты.

```{r}
geotagsDAS <- geotagsMGU["Дом аспиранта и стажера МГУ (ДАС)",]
geotagsFDS <- geotagsMGU["Филиал дома студента МГУ (ФДС)",]
leaflet(geotagsEF) %>%
  addTiles() %>% 
  fitBounds(
    lng1 = geotagsFDS$longitude,
    lat1 = geotagsFDS$latitude,
    lng2 = geotagsDAS$longitude,
    lat2 = geotagsDAS$latitude
            ) %>%
    addMarkers(~longitude,~latitude,popup=htmlEscape(~name))  
```


В следующем примере выводим сразу несколько точек и функция clearBounds()  устанавливает автоматическое определение границ карты по разбросу точек.

```{r}
leaflet(geotagsMGU) %>%
  addTiles() %>% 
  clearBounds( ) %>%
    addMarkers(~longitude,~latitude,popup=htmlEscape(~name))  
```