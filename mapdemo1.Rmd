---
title: "Демонстрация работы библиотеки leaflet для нанесения данных на карту"
author: "Илья Кочергин"
date: "Воскресенье, 3 апреля 2016 года"
output: html_document
---

# Тема 1. Нанесение точек и установление границ карты

Документация библиотеки leaflet <https://rstudio.github.io/leaflet/> 

### Включаем библиотеки 

```{r libaries ,message=FALSE,warning=FALSE}
library(leaflet) # рисование карт
library(dplyr)   # оператор %>% (pipe) и функции манипуляций с данными
library(xtable)  # вывод таблиц в документах LaTeX и Web
library(htmltools) # вспомогательные функции при генерации web content'а

```


### Создаем фрейм данных с координатами объектов

Загружаем  данные о нескольких знаниях МГУ в формате:

* название (name),
* адрес сайта (url)
* широта (latitude)
* долгота (longitude)


```{r}
geotagsMGU <- read.table(header=TRUE,
                         as.is=TRUE,
                         row.names=1,
                         sep=",",
                         text=
"name,url,latitude,longitude
Главное здание МГУ, http://www.msu.ru/info/map/gz.html, 55.703056, 37.530556
Экономический факультет МГУ, http://econ.msu.ru, 55.696040, 37.537793
Ботанический сад МГУ, http://botsad.msu.ru, 55.707701, 37.527202
Дом аспиранта и стажера МГУ (ДАС), http://www.msu.ru/depts/host/das.html, 55.691361, 37.595927
Филиал дома студента МГУ (ФДС), http://www.msu.ru/depts/host/fds.html, 55.707039, 37.509166
")
```

### Форматируем таблицу координат для выдачи в аккуратном виде

Параметры `xtable()`:

* параметр `auto=T` автоматически выравнивает текстовые столбцы по левому, а числовые -- по правому краю (по разрядам)
* параметр `digits=5` -- 5 цифр после "запятой" в числовых полях

```{r, results="asis"}
xtab <-  xtable(geotagsMGU,auto=T,digits=5 )
caption(xtab) <- "Таблица 1. Координаты объектов МГУ"
print(xtab,type="html", caption.placement="bottom", html.table.attributes="border='3' width='100%'")

```

Для удобства добавим в фрейм данных geotagsMGU столбец name, дублирующий названия строк. 

```{r}
geotagsMGU$name <- rownames(geotagsMGU)
```


## Рисуем карты и наносим объекты с всплывающими описаниями

Объекты на карте будут обозначаться маркерами, имеющими форму по умолчанию. Кликнув на них, Вы получите всплывающее окно с именем объекта и/или информацией о нем.

### Пример 1. Один объект. Границы карты определяются масштабом и координатами центра


Создадим фрейм данных, состоящий только из строчки про Экономический факультет.

```{r}
geotagsEF <-  geotagsMGU["Экономический факультет МГУ",]
```
```{r,results="asis"}
geotagsEF %>% xtable(digits=4,auto=T) %>% print(type="html")
```

Создадим объект-карту 

```{r}
m <- leaflet() %>% 
     addTiles() 
```

Установим масштаб (zoom) карты и укажем 1 точку (Экономический факультет) в качестве центра карты при помощи функции `setView()`
При помощи `addMarkers()` нанесем маркер со всплывающим окном в этой же точке.
Если нажать на точку, появится всплывающее окно (popup window)

```{r}
m %>% 
  setView(lng=geotagsEF$longitude, lat=geotagsEF$latitude, zoom = 15) %>%
  addMarkers(lng=geotagsEF$longitude, lat=geotagsEF$latitude, 
    popup="<b>ЭФ МГУ</b><br><a href='http://www.econ.msu.ru'>сайт факультета</a>")
```

### Пример 2. Один объект. Границы карты определяются координатами диагонали прямоугольника 

Теперь указываем не масштаб, а границы. Хотим чтобы карта включала прямоугольник, диагональ которого проведена между 2-мя общежитиями ДАС и ФДС. Используем функцию fitBounds() для определения границ карты.

```{r}
geotagsDAS <- geotagsMGU["Дом аспиранта и стажера МГУ (ДАС)",]
geotagsFDS <- geotagsMGU["Филиал дома студента МГУ (ФДС)",]
leaflet(geotagsEF) %>%
  addTiles() %>% 
  fitBounds(
    lng1 = geotagsFDS$longitude,
    lat1 = geotagsFDS$latitude,
    lng2 = geotagsDAS$longitude,
    lat2 = geotagsDAS$latitude
            ) %>%
    addMarkers(~longitude,~latitude,popup=~htmlEscape(name))  
```

### Пример 3. Много объектов. Границы карты определяются автоматически
 
В этом примере выводим сразу несколько точек и функция clearBounds()  устанавливает автоматическое определение границ карты по разбросу точек.

```{r}
leaflet(data=geotagsMGU) %>%
  addTiles() %>% 
  clearBounds( ) %>%
    addMarkers(~longitude,~latitude,popup=~htmlEscape(name))  
```

Фрейм данных по умолчанию указан еще в функции `leaflet()`, а в остальных  функциях пакета leaflet мы можем ссылаться на столбцы этого dataframe в форме `~имяСтолбца` и указывать параметром `data=` другой dataframe, если нужно.